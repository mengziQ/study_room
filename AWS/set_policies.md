# AWSのアクセス制限  
会社のセキュリティが厳しくなり、会社支給の端末からのみアクセスを許可することになりました。  
どうやってIP制限をかけるのか分からず人に聞いたのでまとめます。  

## IAMでポリシーを設定する  
IAMで特定のIPアドレスからのみ接続を許可するポリシーを設定し、ユーザーグループにポリシーを割り当てます。  

## ポリシーの設定  
1. コンソールでIAMを開く  
2. 画面左「ポリシー」をクリック  
3. 画面上部「ポリシーの作成」をクリック  
4. JSONタブにポリシーを入力、Review policyをクリック  
5. 「名前」と「説明」をてきとうに入力し、アクセス制限を解除したいサービスがあれば「概要」のサービスから選択、「create policy」をクリック  

## ポリシー画面で入力するJSON  
デフォルトでversionとStatementは入ってると思うので、Statementの中だけ入力します。  
```
{
   "Version": "2012-10-17",
   "Statement": [
       {
           "Sid": "IPAddressFilter",
           "Effect": "Deny",
           "Action": [
               "*"
           ],
           "Resource": [
               "*"
           ],
           "Condition": {
               "NotIpAddress": {
                   "aws:SourceIp": [
                       "xxx.xxx.xxx.xxx",
                       "yyy.yyy.yyy.yyy"
                   ]
               }
           }
       }
   ]
}
```
### エレメントの意味  
[amazonの該当ページ](https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/reference_policies_elements.html)
- version:ポリシー言語のバージョン。  
- Statement:ポリシーの主要エレメント。入力必須。  
- Sid:ステートメント内の各エレメント固有のID。  
- Effect:ステートメントの結果をどうするか。入力必須。AllowとDenyのどちらか。  
- Action:許可、または拒否される特定のアクション。「*」だと全てのアクションとなる。  
- Resource:ステートメントで取り扱うオブジェクト。「*」だと全てのリソースとなる。  
- Condition:ポリシーを実行する条件。  
- NotIpAddress:ここに書かれたIPアドレスをポリシーの対象から除く  
- aws:SourceIp:条件キー。IPv4アドレスを記載。  

## ユーザーグループにポリシーを割り当てる  
1. IAMのコンソールで画面左「グループ」を選択  
2. グループ名をクリック  
3. 「アクセス許可」タブをクリック  
4. 「ポリシーのアタッチ」をクリック  
5. ポリシーを選択して、「ポリシーのアタッチ」をクリック  

## 割り当てると実際どうなるか  
- スマホでコンソールにアクセスすると、ログインはできちゃいますが、例えばEC2ではインスタンスが見えなくなったり、「権限がなくて閲覧できない」といった類の文言が画面に表示されました。  
- EC2へのSSH接続はできました。  
- FaaSによるアクセスはできませんでした。  


